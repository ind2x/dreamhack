## File Vulnerability Advanced for linux
<hr style="border-top: 1px solid;"><br>

```
user  nginx;
worker_processes 1;
error_log  /var/log/nginx/nginx_error.log warn;
pid        /var/run/nginx.pid;
events {
    worker_connections 1024;
}
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/nginx_access.log  main;
    sendfile        on;
    keepalive_timeout  65;
    include /etc/nginx/conf.d/*.conf;
}
daemon off;
```

<br>

```python
import os, subprocess
from functools import wraps
from flask import Flask, request

app = Flask(__name__)
API_KEY = os.environ.get('API_KEY', None)

def key_required(view):
    @wraps(view)
    def wrapped_view(**kwargs):
        apikey = request.args.get('API_KEY', None)
        if API_KEY and apikey:
            if apikey == API_KEY:
                return view(**kwargs)
        return 'Access Denined !'
    return wrapped_view


@app.route('/', methods=['GET'])
def index():
    return 'API Index'


@app.route('/file', methods=['GET'])
def file():
    path = request.args.get('path', None)
    if path:
        data = open('./files/' + path).read()
        return data
    return 'Error !'


@app.route('/admin', methods=['GET'])
@key_required
def admin():
    cmd = request.args.get('cmd', None)
    if cmd:
        result = subprocess.getoutput(cmd)
        return result
    else:
        return 'Error !'


if __name__ == '__main__':
    app.run(host='0.0.0.0')
```

<br><br>
<hr style="border: 2px solid;">
<br><br>

## Solution
<hr style="border-top: 1px solid;"><br>

```/file``` 페이지에 가면 ```?path``` 값으로 ```/var/log/nginx/nginx_access.log```을 주면 172로 시작하는 아이피의 로그가 있다.

여기에 보면 ```/admin?API_KEY=d22cb18e86fc9e23996650150461c9f794ad3a4f``` 란 로그가 있는데 이를 통해 API_KEY를 알 수 있었다.

키를 알아낸 다음 ```/admin``` 페이지에서 ```?cmd``` 값으로 ```cd /; ./flag```를 해주면 플래그가 출력된다.

**추가로 ```/proc/self/environ``` 파일을 출력하면 API_KEY가 있다.**

<br>

+ Flag : ```DH{2a4ff4e94d09793c662d1bd7ec5d497d7b190c6f}```

<br><br>
<hr style="border: 2px solid;">
<br><br>
